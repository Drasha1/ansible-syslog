Syslog
  Overview
    this is a complicated syslog over tls setup intended for enviorments where you need syslog-ng for the main server but have to forward logs from older centos 5/6 machines to it.
    The setup has a central syslog-ng server on centos 7 which supports syslog-ng tls and then rsyslog client servers that forward logs

  Files
    /etc/syslog-ng/               || base config directory
    /etc/syslog-ng/syslog-ng.conf || default config file
    /etc/syslog-ng/db-insert.php  || custom db insert script used for 
    /etc/syslog-ng/ca.d/          || stores ca certs has file and a generated number that links to the file
    /etc/syslog-ng/cert.d/        || stores certs for tls encryption
    /etc/syslog-ng/conf.d/        || stores extra configs. I try and keep custom stuff in here
    /var/log/remotelogs/          || logs for specific servers logging here

  Ports
    tcp in/out port 514 || tls traffic from all our servers logging here

  Resources
    https://code.google.com/p/eventlog-to-syslog/ || utility for sending udp logs from windows machines to this server
    http://www.balabit.com/sites/default/files/documents/syslog-ng-ose-latest-guides/en/syslog-ng-ose-guide-admin/html/tlsoptions.html || syslong-ng tls options
    http://www.balabit.com/sites/default/files/documents/syslog-ng-ose-latest-guides/en/syslog-ng-ose-guide-admin/html/procedure-configuring-mutual-tls-server.html || tls setup

  Requirements
    syslog-ng,php,php-mysql
    Centos 7 || for the syslog-ng server. lower versions of centos have bugs that prevent tls working for syslog-ng
    Centos 5,6,7 || these will all work for forwarding log files to the main server

  Debug
    syslog-ng -Fevd || start syslog-ng in debug mode in the foreground. you have to stop syslog first
    internal();     || in the config this is the source for syslog-ng internal errors. you have to send the source to a destionation like any other source

  Errors
    SSL error while reading stream; tls_error='SSL routines:SSL23_READ:ssl handshake failure'
      this is a little complicated. This error pops up for centos 5 rsyslog servers trying to connect to a syslog-ng server when using a pem cert generated by openssl.
      gnutls apprently has issues reading openssl certs on older versions. see http://comments.gmane.org/gmane.network.gnutls.general/2454
      openssl apprently creates PKCS #8 keys which newer versions of openssl and gnutls will automatically adjust for. certtool should be able to fix this but I don't know how.

CA
  Overview
    The stuff for setting up a CA could be its own role but for now its part of the syslog role
    You are going to need a server in the ca group
    you are also going to need to generate a id_rsa key and add it to this role as well as put the public key for it in the capublickey variable
  
  Ansible Variables
    countryName_default=US
    stateOrProvinceName_default=Arizona
    localityName_default=Phoenix 
    organizationalUnitName_default=CompanyName

  files
    /home/ca/CA/cacert.pem        || ca cert this can be freely distrubted and is on all of our servers that are doing syslog over tls
    /home/ca/CA/private/cakey.pem || this is the ca private key. if we lose this any one can sign certs as us
    /home/ca/CA/private/          || contains all private keys for our servers that have been generated
    /home/ca/CA/newcerts          || contains all of the certs we have generated
    /home/ca/CA/openssl.conf      || specific configuration options for generating certs. this is custom
    /home/ca/CA/index*            || lots of crap like index* serial ect. this is used to keep track of certs we have already signed

  Ports
    tcp in/out port 22 for file transfer

  Resources
    http://www.linux.com/community/blogs/129-servers/790912-tls-encryption-and-mutual-authentication-using-syslog-ng-open-source-edition || pretty good overview. has some typos in commands
    http://pages.cs.wisc.edu/~zmiller/ca-howto/ || don't think i used much from this

  Requirements
    openssl

  Basic Tasks
    openssl x509 -noout -text -in file.crt || view cert info
    openssl verify -CAfile cacert.pem clientcert.pem || verify the cert auth is good using our ca file
    openssl s_client -CAfile cacert.pem -key key.pem -cert crt.pem -connect 127.0.0.1:514 || test ca, key, cert against a remote server
    gnutls-cli --x509cafile cacert.pem --x509keyfile key.pem --x509certfile crt.pem --port 514 127.0.0.1 || connects to a server to test the connection using gnutls specifically (rsyslog specific tls test)
    certtool -k --infile key.pem || tests if you can read a key
    certtool -8 -k --infile key.pem || tests a key and uses pkcs8 which won't auto detect on centos 5 and older distros

Example Setup
  This would setup server1 to be the central log server and it would store the ca certifcate. server2 would be setup to send logs to server1
  [syslogng]
  server1
  [ca]
  server1

  ---
  - hosts: server1
    roles: syslog
  - hosts: server2
    roles: syslog

